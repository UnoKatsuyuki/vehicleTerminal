/* empty css                  *//* empty css                           *//* empty css                        */import{g as te,b as oe}from"./taskApi-BS2Yhaaa.js";/* empty css                *//* empty css                        *//* empty css                       */import{_ as se,r as m,c as w,o as ne,X as re,y as R,p as ie,D as de,b as g,f as a,d as s,w as l,B as ue,a5 as ce,a6 as me,F as _e,e as fe,$ as pe,H as ve,g as be,h as k,E as we,x as n,J as ge,K as ke,k as ye,u as Ee,a7 as Ie,Z as Ce,a2 as Ve,a8 as xe,a4 as Ne,a9 as Te,aa as De,t as u,I as Fe,Q as Se,S as Ue,j as he,C as Be,L as Re,ab as $e,ac as Me,M as Je}from"./index-CCAfALLo.js";import"./index-Dq7h7Pqt.js";const Le={class:"task-detail-view"},ze={class:"header-actions"},He={class:"main-container"},Oe={class:"content-area"},Pe={class:"image-area"},Ae={class:"image-slot"},je={class:"scale-bar-area"},Ge=["onClick"],Ke={class:"sidebar"},Qe={class:"status-confirmed"},Xe={class:"status-pending"},Ze={key:0,class:"modal-body"},qe={class:"modal-image-container"},We={class:"modal-info-container"},Ye={class:"dialog-footer"},ea={__name:"TaskReview",setup(aa){const $=re(),x=be(),y=m(!0),f=m(null),_=m({}),c=m([]),N=m(0),T=m(new Map),o=m(null),p=m(!1),M=w(()=>o.value?o.value.flawImageUrl:""),E=w(()=>o.value?o.value.initialConfirmed!==null:!0),J=w(()=>c.value.length===0?!0:c.value.every(t=>t.confirmed!==null));ne(()=>{f.value=$.params.id,f.value&&L()});async function L(){y.value=!0;try{const[t,e]=await Promise.all([te(f.value),oe({taskId:f.value,pageSize:999})]);_.value=t,c.value=e.rows.filter(i=>i.taskId==f.value).map(i=>{const V=i.flawImageUrl?`/prod-api/file${i.flawImageUrl}`:"";return{...i,flawImageUrl:V,initialConfirmed:i.confirmed}})}catch(t){console.error("获取复盘数据失败:",t),R.error("获取复盘数据失败，请检查网络或联系管理员")}finally{y.value=!1}}function z(){x.back()}const H=t=>{const e=parseFloat(_.value.taskTrip);return e?`${t/e*100}%`:"0%"};function D(t){return t.confirmed===!0?{text:"已确认",className:"status-confirmed"}:t.confirmed===!1?{text:"已忽略",className:"status-ignored"}:{text:"待处理",className:"status-pending"}}const I=w(()=>{const t={total:c.value.length,confirmed:0,pending:0,ignored:0};return c.value.forEach(e=>{e.confirmed===!0?t.confirmed++:e.confirmed===!1?t.ignored++:t.pending++}),t}),O=({row:t})=>D(t).className;function C(t){o.value=JSON.parse(JSON.stringify(t)),p.value=!0}function P(){if(!o.value)return;const t=c.value.findIndex(e=>e.id===o.value.id);if(t!==-1){const e={...c.value[t],confirmed:o.value.confirmed,remark:o.value.remark};c.value.splice(t,1,e),T.value.set(o.value.id,{id:o.value.id,confirmed:o.value.confirmed,remark:o.value.remark}),R.success("修改已暂存")}p.value=!1}function A(){const t=Array.from(T.value.values());sessionStorage.setItem("flawUpdates",JSON.stringify(t)),x.push({name:"task-upload",params:{id:f.value}})}return(t,e)=>{const i=ke,V=ge,v=we,j=ue,G=ye,F=ce,K=me,Q=xe,d=De,S=Te,U=Ne,b=Se,X=Fe,Z=pe,h=Me,q=$e,B=Re,W=Je,Y=Be,ee=ve,ae=de;return ie((k(),g("div",Le,[a(j,{onBack:z},{content:l(()=>[a(V,{separator:"/"},{default:l(()=>[a(i,null,{default:l(()=>e[5]||(e[5]=[n("地铁隧道巡线车智能巡检系统")])),_:1,__:[5]}),a(i,null,{default:l(()=>e[6]||(e[6]=[n("任务列表")])),_:1,__:[6]}),a(i,null,{default:l(()=>e[7]||(e[7]=[n("任务详情与复盘")])),_:1,__:[7]})]),_:1})]),extra:l(()=>[s("div",ze,[a(v,{type:"primary",onClick:A,disabled:!J.value},{default:l(()=>e[8]||(e[8]=[n(" 完成复盘并上传 ")])),_:1,__:[8]},8,["disabled"])])]),_:1}),s("div",He,[s("div",Oe,[s("div",Pe,[a(F,{src:M.value,fit:"contain"},{error:l(()=>[s("div",Ae,[a(G,null,{default:l(()=>[a(Ee(Ie))]),_:1}),e[9]||(e[9]=s("span",null,"请从右侧或下方选择一个缺陷以预览图片",-1))])]),_:1},8,["src"])]),s("div",je,[a(K,{modelValue:N.value,"onUpdate:modelValue":e[0]||(e[0]=r=>N.value=r),max:parseFloat(_.value.taskTrip)||100,"show-tooltip":!1,disabled:""},null,8,["modelValue","max"]),(k(!0),g(_e,null,fe(c.value,r=>(k(),g("div",{key:`marker-${r.id}`,class:Ve(["flaw-marker",D(r).className]),style:Ce({left:H(r.flawDistance)}),onClick:le=>C(r)},[a(Q,{content:r.flawName,placement:"top"},{default:l(()=>e[10]||(e[10]=[s("span",null,"📍",-1)])),_:2,__:[10]},1032,["content"])],14,Ge))),128))])]),s("div",Ke,[a(Z,null,{default:l(()=>[a(U,{shadow:"never",class:"info-card"},{header:l(()=>e[11]||(e[11]=[s("div",{class:"card-header"},[s("span",null,"📄 任务信息")],-1)])),default:l(()=>[a(S,{column:1,border:""},{default:l(()=>[a(d,{label:"任务编号"},{default:l(()=>[n(u(_.value.taskCode),1)]),_:1}),a(d,{label:"开始时间"},{default:l(()=>[n(u(_.value.execTime),1)]),_:1}),a(d,{label:"结束时间"},{default:l(()=>[n(u(_.value.endTime),1)]),_:1}),a(d,{label:"行驶距离"},{default:l(()=>[n(u(_.value.taskTrip)+" 米",1)]),_:1}),a(d,{label:"故障总计"},{default:l(()=>[n(u(I.value.total),1)]),_:1}),a(d,{label:"已确定故障"},{default:l(()=>[s("span",Qe,u(I.value.confirmed),1)]),_:1}),a(d,{label:"疑似故障"},{default:l(()=>[s("span",Xe,u(I.value.pending),1)]),_:1})]),_:1})]),_:1}),a(U,{shadow:"never",class:"info-card"},{header:l(()=>e[12]||(e[12]=[s("div",{class:"card-header"},[s("span",null,"⚠️ 故障历史")],-1)])),default:l(()=>[a(X,{data:c.value,style:{width:"100%"},onRowClick:C,"row-class-name":O},{default:l(()=>[a(b,{prop:"flawName",label:"故障名称"}),a(b,{prop:"flawType",label:"类型",width:"80"}),a(b,{prop:"flawDistance",label:"位置(m)",width:"80"}),a(b,{label:"操作",width:"70",align:"center"},{default:l(r=>[a(v,{link:"",type:"primary",onClick:Ue(le=>C(r.row),["stop"])},{default:l(()=>e[13]||(e[13]=[n("详情")])),_:2,__:[13]},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1})]),_:1})])]),a(ee,{modelValue:p.value,"onUpdate:modelValue":e[4]||(e[4]=r=>p.value=r),title:"故障详情与确认",width:"70%",top:"5vh"},{footer:l(()=>[s("span",Ye,[a(v,{onClick:e[3]||(e[3]=r=>p.value=!1)},{default:l(()=>e[16]||(e[16]=[n("取 消")])),_:1,__:[16]}),a(v,{type:"primary",onClick:P,disabled:E.value},{default:l(()=>e[17]||(e[17]=[n("确 定")])),_:1,__:[17]},8,["disabled"])])]),default:l(()=>[o.value?(k(),g("div",Ze,[s("div",qe,[a(F,{src:o.value.flawImageUrl,fit:"contain","preview-src-list":[o.value.flawImageUrl],"preview-teleported":""},null,8,["src","preview-src-list"])]),s("div",We,[a(S,{column:1,border:"",title:"故障信息"},{default:l(()=>[a(d,{label:"故障名称"},{default:l(()=>[n(u(o.value.flawName),1)]),_:1}),a(d,{label:"故障类型"},{default:l(()=>[n(u(o.value.flawType),1)]),_:1}),a(d,{label:"故障描述"},{default:l(()=>[n(u(o.value.flawDesc||"无"),1)]),_:1}),a(d,{label:"故障位置"},{default:l(()=>[n(u(o.value.flawDistance)+" 米",1)]),_:1})]),_:1}),a(Y,{class:"modal-form","label-position":"top",model:o.value},{default:l(()=>[a(B,{label:"是否属实"},{default:l(()=>[a(q,{modelValue:o.value.confirmed,"onUpdate:modelValue":e[1]||(e[1]=r=>o.value.confirmed=r),disabled:E.value},{default:l(()=>[a(h,{value:!0},{default:l(()=>e[14]||(e[14]=[n("是")])),_:1,__:[14]}),a(h,{value:!1},{default:l(()=>e[15]||(e[15]=[n("否 (误报)")])),_:1,__:[15]})]),_:1},8,["modelValue","disabled"])]),_:1}),a(B,{label:"补充说明"},{default:l(()=>[a(W,{modelValue:o.value.remark,"onUpdate:modelValue":e[2]||(e[2]=r=>o.value.remark=r),type:"textarea",rows:5,placeholder:"请输入补充说明",disabled:E.value},null,8,["modelValue","disabled"])]),_:1})]),_:1},8,["model"])])])):he("",!0)]),_:1},8,["modelValue"])])),[[ae,y.value]])}}},ca=se(ea,[["__scopeId","data-v-b0c00510"]]);export{ca as default};
