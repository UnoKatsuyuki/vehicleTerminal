# 数据源切换功能说明

## 功能概述

本系统支持在本地数据源和小车数据源之间进行切换，方便开发测试和生产环境使用。

## 数据源类型

### 1. 本地数据源 (Local Data Source)
- **用途**: 开发测试环境
- **后端地址**: `http://localhost:8080`
- **特点**: 使用本地数据库和后端接口，适合开发和测试
- **支持的方法**: 只包含jincangApi.js中原有的方法

### 2. 小车数据源 (Vehicle Data Source)
- **用途**: 生产环境
- **后端地址**: `http://192.168.2.57/prod-api`
- **摄像头服务**: `http://192.168.2.57/easy-api`
- **流媒体服务**: `http://192.168.2.57/webrtc-api`
- **特点**: 连接真实的小车设备，获取实时数据
- **支持的方法**: 包含所有carApi.js中的方法

## 实现策略

### API方法分配原则
- **jincangApi.js中有的方法**: 根据数据源切换使用本地或小车API
- **jincangApi.js中没有的方法**: 统一使用carApi.js中的方法

### jincangApi.js包含的方法
- 任务管理: `listTask`, `getTask`, `addTask`, `updateTask`, `delTask`, `preUploadTask`, `uploadTask`, `startTask`, `endTask`
- 故障管理: `listFlaw`, `getFlaw`, `addFlaw`, `updateFlaw`, `delFlaw`, `confirmFlaw`, `uploadFlaw`, `batchUpdateFlaw`
- 实时数据: `getLiveFlawInfo`, `checkAllFlawsConfirmed`
- 系统检查: `checkFs`, `checkDb`, `checkAgv`, `checkCam`

### 统一使用carApi.js的方法
- 摄像头相关: `getDeviceList`, `getVideoStreamUrl`
- AGV控制: `agvForward`, `agvStop`, `agvBackward`, `getAgvHeartbeat`
- 任务详情: `getTaskDetails`, `getFlawList`, `getFlawDetails`
- 故障更新: `updateFlaw_vehicle`

## 使用方法

### 1. 在TaskList界面切换数据源
1. 打开任务列表页面
2. 在页面顶部找到数据源切换开关
3. 点击开关切换数据源：
   - 开关打开：使用本地数据源
   - 开关关闭：使用小车数据源
4. 系统会自动重新加载数据

### 2. 数据源状态显示
- 当前数据源名称和描述会显示在切换开关旁边
- 图标会显示当前数据源类型：
  - 🖥️ 显示器图标：本地数据源
  - 🚐 货车图标：小车数据源

### 3. 自动连接检测
- 切换到小车数据源时，系统会自动检测连接状态
- 如果小车连接失败，会自动切换到本地数据源
- 连接状态会保存在本地存储中

## 技术实现

### 1. 文件结构
```
src/
├── api/
│   ├── carApi.js          # 小车数据源API（完整功能）
│   ├── jincangApi.js      # 本地数据源API（仅包含原有方法）
│   └── apiManager.js      # API管理器（统一入口）
├── utils/
│   └── dataSourceManager.js # 数据源管理器
└── views/task/
    └── TaskList.vue       # 任务列表页面（包含切换开关）
```

### 2. 核心组件

#### dataSourceManager.js
- 管理数据源状态
- 处理数据源切换逻辑
- 保存数据源选择到本地存储

#### apiManager.js
- 根据当前数据源自动选择API
- 提供统一的API接口
- 对于jincangApi.js中没有的方法，统一使用carApi.js

#### TaskList.vue
- 提供数据源切换UI
- 显示当前数据源状态
- 处理切换事件

### 3. 代理配置
在 `vite.config.js` 中配置了代理：
```javascript
proxy: {
  '/prod-api': {
    target: 'http://192.168.2.57',
    changeOrigin: true,
  },
  '/local-api': {
    target: 'http://localhost:8080',
    changeOrigin: true,
  }
}
```

## 注意事项

1. **本地数据源限制**: 本地数据源只支持jincangApi.js中原有的方法
2. **功能差异**: 某些小车特有功能（如摄像头、AGV控制）在本地数据源中不可用
3. **数据一致性**: 不同数据源的数据可能不完全一致
4. **网络连接**: 切换数据源时会进行连接测试
5. **开发建议**: 开发时使用本地数据源，测试时切换到小车数据源

## 故障排除

### 1. 切换失败
- 检查目标数据源服务是否正常运行
- 检查网络连接
- 查看浏览器控制台错误信息

### 2. 数据加载失败
- 确认当前数据源配置正确
- 检查API接口是否可用
- 查看网络请求状态

### 3. 功能不可用
- 确认该功能是否在jincangApi.js中实现
- 如果不在，该功能将统一使用小车数据源
- 检查小车连接状态

## 开发建议

1. **开发阶段**: 建议使用本地数据源进行开发和测试
2. **调试阶段**: 可以切换到小车数据源进行真实环境测试
3. **生产环境**: 使用小车数据源获取真实数据
4. **功能扩展**: 如需在本地数据源中添加新功能，请在jincangApi.js中实现 